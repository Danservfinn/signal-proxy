# Signal API Adapter for Moltbot
# Translates Moltbot's expected API format to signal-cli-rest-api format

:8080 {
    # Health check endpoint
    # Moltbot calls: /api/v1/check
    # signal-cli-rest-api provides: /v1/about (not /v1/health which doesn't exist)
    handle /api/v1/check {
        rewrite * /v1/about
        reverse_proxy https://signal-cli-rest-api-production-010a.up.railway.app {
            header_up Host {upstream_hostport}
            header_up X-Forwarded-Host {host}
        }
    }

    # Events/receive endpoint
    # Moltbot calls: /api/v1/events?account=+15165643945
    # signal-cli-rest-api provides: /v1/receive/+15165643945
    # Note: Using direct path rewrite since there's only one account
    handle /api/v1/events {
        rewrite * /v1/receive/%2B15165643945
        reverse_proxy https://signal-cli-rest-api-production-010a.up.railway.app {
            header_up Host {upstream_hostport}
            header_up X-Forwarded-Host {host}
        }
    }

    # Send message endpoint
    # Moltbot calls: /api/v1/send
    # signal-cli-rest-api provides: /v2/send
    handle /api/v1/send {
        rewrite * /v2/send
        reverse_proxy https://signal-cli-rest-api-production-010a.up.railway.app {
            header_up Host {upstream_hostport}
            header_up X-Forwarded-Host {host}
        }
    }

    # Pass through any other v1 requests
    handle /v1/* {
        reverse_proxy https://signal-cli-rest-api-production-010a.up.railway.app {
            header_up Host {upstream_hostport}
            header_up X-Forwarded-Host {host}
        }
    }

    # Pass through any other v2 requests
    handle /v2/* {
        reverse_proxy https://signal-cli-rest-api-production-010a.up.railway.app {
            header_up Host {upstream_hostport}
            header_up X-Forwarded-Host {host}
        }
    }

    # Default handler
    handle {
        respond "Signal API Proxy" 200
    }

    log {
        output stdout
        format console
        level INFO
    }
}
